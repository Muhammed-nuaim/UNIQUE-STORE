<%- include('../layouts/admin/header.ejs') %>
<script src="https://cdn.tailwindcss.com"></script>
  <div class="container mx-auto p-4">
      <div class="flex justify-between items-center mb-6">
          <div>
              <h1 class="text-2xl font-bold">Order Detail</h1>
              <p class="text-gray-600">Details for Order ID: <%= orderDetails._id %></p>
          </div>
          <div class="flex items-center space-x-2">
              <select class="border rounded p-2" id="status">
                  <option><%= orderDetails.status %></option>
                  <option>Processing</option>
                  <option>Pending</option>
                  <option>Shipped</option>
                  <option>Delivered</option>
              </select>
              <button class="bg-blue-500 text-white px-4 py-2 rounded" onclick="updateStatus('<%= orderDetails._id %>')">Save</button>
              <button class="border border-gray-300 px-4 py-2 rounded">Print</button>
          </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div class="bg-white p-4 rounded shadow">
              <h2 class="text-lg font-semibold mb-2">Customer</h2>
              <p><%= orderDetails.address[0].name %></p>
              <p><%= orderDetails.address[0].phone %></p>
              <a href="#" class="text-blue-500">View profile</a>
          </div>

          <div class="bg-white p-4 rounded shadow">
              <h2 class="text-lg font-semibold mb-2">Order Info</h2>
              <p>Shipping: Fargo express</p>
              <p>Pay method: <%= orderDetails.paymentMethod %></p>
              <p>Status: <%= orderDetails.status %></p>
              <a href="#" class="text-blue-500">Download info</a>
          </div>

          <div class="bg-white p-4 rounded shadow">
              <h2 class="text-lg font-semibold mb-2">Deliver to</h2>
              <p>City: <%= orderDetails.address[0].city %>, <%= orderDetails.address[0].state %></p>
              <p>Land-Mark: <%= orderDetails.address[0].landMark %></p>
              <p>Pincode: <%= orderDetails.address[0].pincode %></p>
          </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="md:col-span-2">
              <div class="bg-white p-4 rounded shadow">
                  <h2 class="text-lg font-semibold mb-4">Order Items</h2>
                  <table class="w-full">
                      <thead>
                          <tr class="border-b">
                              <th class="text-left p-2">Image</th>
                              <th class="text-left p-2">Product</th>
                              <th class="text-right p-2">Unit Price</th>
                              <th class="text-right p-2">Quantity</th>
                              <th class="text-right p-2">Total</th>
                              <th class="text-right p-2">Total</th>
                          </tr>
                      </thead>
                      <tbody>
                        <% for ( i = 0 ; i < orderDetails.orderedItems.length ; i++ ) { %>
                          <tr class="border-b">
                              <td class="p-2">
                                  <img src="/uploads/re-image/<%= orderDetails.orderedItems[i].productImage[0] %>" alt="<%= orderDetails.orderedItems[i].productName %>" class="w-12 h-12 object-cover rounded">
                              </td>
                              <td class="p-2"><%= orderDetails.orderedItems[i].productName %></td>
                              <td class="text-right p-2">₹<%= orderDetails.orderedItems[i].price %></td>
                              <td class="text-right p-2"><%= orderDetails.orderedItems[i].quantity %></td>
                              <td class="text-right p-2">₹<%= orderDetails.orderedItems[i].totalPrice %></td>
                              <td class="text-right p-2"><button class="bg-red-500 text-white px-2 py-2 rounded" onclick="productCancelled('<%= orderDetails._id %>','<%= orderDetails.orderedItems[i]._id%>')">Cancelled</button></td>
                          </tr>
                          <% } %>
                      </tbody>
                      <tfoot>
                          <tr class="font-bold">
                              <td colspan="4" class="text-right p-2">Subtotal:</td>
                              <td class="text-right p-2"><%= orderDetails.finalAmount %></td>
                              <td></td>
                          </tr>
                          <tr>
                              <td colspan="4" class="text-right p-2">Delivery Charge:</td>
                              <td class="text-right p-2">Free</td>
                              <td></td>
                          </tr>
                          <tr class="font-bold text-lg">
                              <td colspan="4" class="text-right p-2">Total:</td>
                              <td class="text-right p-2">₹<%= orderDetails.finalAmount %></td>
                              <td></td>
                          </tr>
                      </tfoot>
                  </table>
              </div>
          </div>
      </div>
  </div>


<%- include('../layouts/admin/footer.ejs') %>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Function to update the order status
    function updateStatus(orderId) {
        // Get the selected status value
        const selectedStatus = document.getElementById("status").value;

        // Show a confirmation alert using SweetAlert before updating
        Swal.fire({
            title: 'Are you sure?',
            text: "Do you want to update the order status?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, update it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                // Proceed with AJAX request to update the status
                $.ajax({
                    url: "/admin/updateStatus",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        orderId: orderId,
                        status: selectedStatus
                    }),
                    success: function(response) {
                        if(response.success) {
                            Swal.fire('Updated!', 'Order status has been updated.', 'success').then(() => {
                                location.reload(); // Reload the page to show updated status
                            });
                        } else {
                            Swal.fire('Error!', 'Failed to update order status.', 'error');
                        }
                    },
                    error: function() {
                        Swal.fire('Error!', 'An error occurred while updating status.', 'error');
                    }
                });
            }
        });
    }

    function productCancelled(orderId,id) {

        Swal.fire({
            title: 'Are you sure?',
            text: "Do you want to Cancel this order?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, cancel it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                // Proceed with AJAX request to update the status
                $.ajax({
                    url: "/admin/productCancelled",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        orderId: orderId,
                        id: id
                    }),
                    success: function(response) {
                        if(response.success == 1) {
                            Swal.fire('Updated!', 'Order has been updated.', 'success').then(() => {
                                location.reload();
                            });
                        } else if (response.success == 2) {
                            Swal.fire('Updated!', 'Order has been updated.', 'success').then(() => {
                                window.location.href='/admin/orderList'
                            });
                        } else {
                            Swal.fire('Error!', 'Failed to cancell order .', 'error');
                        }
                    },
                    error: function() {
                        Swal.fire('Error!', 'An error occurred while updating status.', 'error').then(() => {
                                window.location.href='/admin/login'
                        });
                    }
                });
            }
        });
    }
</script>
